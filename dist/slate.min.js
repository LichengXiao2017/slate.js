// Boost Browser and DOM Tools
// (c) 2014, Mathigon / Philipp Legner
// MIT License (https://github.com/Mathigon/slate.js/blob/master/LICENSE)

!function(){M.audio={files:{},playing:null,load:function(a,b){return M.Audio.files[b]=new Audio(a),M.Audio.files[b].load(),M.Audio.files[b].addEventListener("timeupdate",function(){M.Audio.playing&&M.Audio.playing.update()}),M.Audio.files[b]}},M.audio.Chunk=M.Class.extend({init:function(a,b){M.isString(b)&&(b=b.split("|").toNumbers()),this.times=b,this.currentTime=b[0],this.duration=b[1]-b[0],this.player=M.Audio.files[a]||M.Audio.load(a,Math.floor(1e4*Math.random())),this.ended=!1},play:function(){var a=this;return this.player.readyState<2?void $(this.player).one("canplay seeked",function(){a.play()}):(M.Audio.playing&&M.Audio.playing.pause(),M.Audio.playing=this,this.ended=!1,this.player.currentTime=this.currentTime,this.player.play(),void this.trigger("play",{p:(this.currentTime-this.times[0])/this.duration,t:this.currentTime}))},pause:function(){M.Audio.playing===this&&this.player.pause(),this.trigger("pause")},setTime:function(a){this.player.readyState&&(this.player.currentTime=a),this.trigger("timeupdate",{p:(a-this.times[0])/this.duration,t:a})},reset:function(){M.Audio.playing===this&&this.player.pause(),this.player.readyState&&(this.currentTime=this.times[0]),this.ended=!0,this.trigger("reset")},update:function(){return this.ended?void 0:(M.Audio.playing===this&&(this.currentTime=this.player.currentTime),this.currentTime>=this.times[1]?(this.ended=!0,this.pause(),void this.trigger("end")):void this.trigger("timeupdate",{p:(this.currentTime-this.times[0])/this.duration,t:this.currentTime}))}}),M.speechRecognition=function(){if(!M.browser.speechRecognition)return{start:function(){a.start()},stop:function(){a.stop()},addCommand:function(){},removeCommand:function(){},available:!1};var a=new window.webkitSpeechRecognition;a.continuous=!0,a.language="en-US";var b={},c=function(a){a=a.toLowerCase().trim(),b[a]&&b[a]()};a.onresult=function(a){for(var b=a.resultIndex;b<a.results.length;++b)console.debug("Voice Input: ",a.results[b][0].transcript),c(a.results[b][0].transcript)};var d=function(a,c){a instanceof Array||(a=[a]);for(var d=0;d<a.length;++d)b[a[d].toLowerCase()]=c},e=function(a){a instanceof Array||(a=[a]);for(var c=0;c<a.length;++c)b[a[c].toLowerCase()]=void 0};return{start:function(){a.start()},stop:function(){a.stop()},addCommand:d,removeCommand:e,available:!0}},M.Bubble=function(a,b){var c=this,d=$C("popup-bubble",a)[0];if(d){var e=$C("bubble-box",d)[0];$N("span",{"class":"bubble-arrow"},d),c.open=function(){b.activePopup&&b.activePopup.close(),d.css("display","block");var f=d.$el.getBoundingClientRect(),g=f.top-f.height,h=f.left-f.width/2,i=f.right+f.width/2,j=b.$container.offset().left,k=M.browser.width;j+10>h&&e.transformX(j+10-h),i>k-54&&e.transformX(k-54-i),M.redraw(),27>g&&b.scrollBy(g-27),a.addClass("on"),b.activePopup=c},c.close=function(){a.removeClass("on"),b.activePopup=null,setTimeout(function(){d.css("display","none")},200)},c.delete=function(){a.off("click",f)};var f=function(b){b.preventDefault(),b.stopPropagation(),a.hasClass("on")?c.close():c.open()};d.click(function(a){a.stopPropagation()}),a.click(f)}},M.Gallery=function(a,b){b||(b={});var c=$N("div",{"class":"gallery-wrapper"}),d=$N("div",{"class":"gallery-box"});a.wrap(c),c.wrap(d);var e,f,g,h=a.children(),i=h.length,j=a.attr("data-slide-width")||null,k=0,l=0,m=$N("div",{"class":"gallery-next"},d),n=$N("div",{"class":"gallery-back"},d);$N("div",{"class":"icon"},m),$N("div",{"class":"icon"},n);var o=$N("div",{"class":"gallery-dots"},d),p=[];h.each(function(a){a.addClass("gallery-slide"),p.push($N("div",{"class":"gallery-dot"},o))});var q,r,s,t,u=function(b){l=b,a.transformX(b)},v=function(a){k=a,p.each(function(b,c){b.setClass("on",c>=a&&a+f>c)}),b.callback&&b.callback(a),m.setClass("disabled",a===i-f),n.setClass("disabled",0===a)},w=function(){e=c.width("border"),f=j?Math.ceil(e/j):1,g=e/f,h.each(function(a){a.css("width",g+"px")}),a.css("width",i*g+"px"),u(-k*g),v(k)},x="quad",y=500,z=!1,A=function(){q=M.now()-t,u(r+s*M.easing(x,q/y))},B=function(){!z&&y>q&&M.animationFrame(B),A()},C=function(a){z=!1,q=0,r=l,s=-a*g-l,t=M.now(),v(a),B()},D=function(){x="quad",i-f>k&&(m.pulse(),C(k+1))},E=function(){x="quad",k>0&&(n.pulse(),C(k-1))};m.click(D),n.click(E);var F=null,G=null,H=null,I=null,J=function(){M.$body.on("mousemove touchmove",K),M.$body.on("mouseup mouseleave touchend touchcancel",L),z=!0,F=l,G=event.touches?event.touches[0].clientX:event.clientX,I=H=G},K=function(a){a.preventDefault();var b=event.touches?event.touches[0].clientX:event.clientX;H=I,I=b;var c=F-G+b,d=-(i-f)*g;u(c>0?c/4:d>c?d+(c-d)/4:c)},L=function(){M.$body.off("mousemove touchmove",K),M.$body.off("mouseup mouseleave touchend touchcancel",L);var a=(event.touches?event.touches[0].clientX:event.clientX,I-H),b=a>12?1:-12>a?-1:0;x="quad-out",C(Math.round(-l/g-b).bound(0,i-f))};return c.on("mousedown touchstart",J),w(),M.resize(w),{next:D,back:E}},M.Lightbox=function(a,b){function c(a){var b=a.attr("src"),c=$N("div",{"class":"lightbox"});a.wrap(c),$N("div",{"class":"lightbox-zoom"},c),c.click(function(){d(c,b)})}function d(a,c){f=a,g.css("display","block");var d=a.$el.getBoundingClientRect(),e=h.$el.getBoundingClientRect(),j=d.left+d.width/2-e.left-e.width/2,k=d.top+d.height/2-e.top-e.height/2,l=Math.max(d.width/e.width,d.height/e.height);i={X:j,Y:k,S:l},h.css("background-image","url("+c.replace(/\.(?=[^.]*$)/,"-large.")+"), url("+c+")"),h.transform("translate("+j+"px,"+k+"px) scale("+l+")"),M.redraw(),h.addClass("transitions"),M.redraw(),a.css("visibility","hidden"),b.$toolbar.addClass("off"),g.addClass("on"),h.transform("scale(1) translate(0,0)")}function e(){g.removeClass("on"),h.transform("translate("+i.X+"px,"+i.Y+"px) scale("+i.S+")"),b.$toolbar.removeClass("off"),setTimeout(function(){f.css("visibility","visible"),g.css("display","none"),h.transform("none"),h.transform("none"),h.removeClass("transitions")},400)}var f,g=$N("div",{"class":"lightbox-overlay"},a),h=$N("div",{"class":"lightbox-img"},g),i=($N("div",{"class":"lightbox-caption"},g),{});return g.click(function(){e()}),{add:c,open:d,close:e}},function(){M.scrollReveal=function(a){function b(){g=window.innerHeight}function c(){h=window.pageYOffset}function d(a,b){var c=a.$el.offsetTop,d=a.$el.offsetHeight;return c+d>=h+b*g&&h+(1-b)*g>=c}function e(a){function b(){e=!0,a.css("opacity","1"),a.transform("translate"+g+"(0)")}function c(){e=!1,a.css("opacity","0"),a.transform("translate"+g+"("+h+j+")")}var e=!1,f=(a.attr("data-scroll")||"").split("|"),g=M.isOneOf(f[0],"left","right")?"X":"Y",h=M.isOneOf(f[0],"top","left")?"-":"",i=M.isNaN(+f[1])?.2:+f[1],j=f[2]||"40px",k=f[3]||".5s",l=f[4]||"0s";return c(),M.redraw(),a.transition(["opacity",k,l,",",M.prefix("transform"),k,l].join(" ")),function(){!e&&d(a,i)&&b(),e&&!d(a,0)&&c()}}function f(){c();for(var a=0;j>a;++a)i[a]()}var g;M.resize(b),b();var h,i=a.each(function(a){return e(a)}),j=i.length;M.$body.scroll(f),M.resize(f),f(),setTimeout(function(){f()},500)}}(),M.Draggable=M.Class.extend({init:function(a,b,c,d){var e,f,g=this,h="y"!==c,i="x"!==c,j=[0,0],k=[null,null],l=function(a){return[event.touches?a.touches[0].clientX:a.clientX,event.touches?a.touches[0].clientY:a.clientY]},m=function(b,c){h&&a.css("left",Math.round(b)+"px"),i&&a.css("top",Math.round(c)+"px"),g.trigger("change",{x:b,y:c,width:e,height:f})};this.set=function(a,b){m(a,b),j=[a,b]},this.get=function(){return{x:j[0],y:j[1],width:e,height:f}};var n=function(a){M.$body.on("mousemove touchmove",o),M.$body.on("mouseup mouseleave touchend touchcancel",p),k=l(a),g.trigger("start")},o=function(a){a.preventDefault();var b=l(a),c=(j[0]+b[0]-k[0]).bound(0,e),d=(j[1]+b[1]-k[1]).bound(0,f);m(c,d)},p=function(a){M.$body.off("mousemove touchmove",o),M.$body.off("mouseup mouseleave touchend touchcancel",p);var b=l(a);if(b[0]===k[0]&&b[1]===k[1])g.trigger("click");else{var c=(j[0]+b[0]-k[0]).bound(0,e),d=(j[1]+b[1]-k[1]).bound(0,f);j=[c,d],g.trigger("end")}};a.on("mousedown touchstart",n);var q=function(){var a=e,c=f;e=b.width("border")-2*d,f=b.height("border")-2*d,g.set(e/(a||e)*j[0],f/(c||f)*j[1])};q(),M.resize(q)}}),M.Slider=M.Class.extend({init:function(a,b){var c=this;a.addClass("slider-track");var d=$N("div",{"class":"slider-knob"},a);$N("div",{"class":"icon"},d);var e,f=new M.Draggable(d,a,"x",4);f.on("start",function(){g=!0}),f.on("change",function(a){var d=Math.floor(a.x/a.width*b);d!==e&&c.trigger("move",d),e=d});var g=!1;f.on("click",function(){c.play()});var h=function(){var a=f.get();!g&&a.x<a.width&&M.animationFrame(h),f.set(a.x+2)};this.play=function(){g=!1,d.pulse(),h()},f.set(0,0)}}),M.ImageSequence=M.Class.extend({init:function(a){var b=$N("div");a.wrap(b);for(var c=a.attr("data-src"),d=Number(a.attr("data-pages"))-1,e=$N("div",{},b),f=new M.Slider(e,d),g=[],h=1;d>h;++h)g[h]=new Image,g[h].src=c.replace("#",h);f.on("move",function(b){a.attr("src",c.replace("#",b))}),f.trigger("move",0)}}),M.makeVariable=function(a,b){var c=b.varValues,d=new Function("_vars","with(_vars){ return "+a.html()+"; }"),e={$el:a,fn:d},f=a.attr("data-fn"),g=f?new Function("_vars","with(_vars){ "+f+" }"):null;if(b.varEvals.push(e),a.attr("data-var")){a.addClass("var");var h=a.attr("data-var").split("|"),i=h[0],j=h[1],k=h[2],l=h[3]?h[3].split(","):[];if(a.html(""),"slider"===k){c[i]=Number(j),a.addClass("var-slider"),l[0]=Number(l[0]),l[1]=Number(l[1]),l[2]=Number(l[2]),e.$el=$N("span",{"class":"var-slider-text"},a),$N("span",{"class":"left"},a),$N("span",{"class":"right"},a);var m=$N("span",{"class":"var-slider-bubble"},a),n=$N("span",{"class":"var-slider-bubble-box "},m),o=$N("span",{"class":"var-slider-progress"},n);$N("span",{"class":"var-slider-bubble-arrow"},m),o.css("width",116*(c[i]-l[0])/(l[1]-l[0])+"px");var p=0,q=0,r=0,s=Math.sqrt(l[2]/(l[1]-l[0])*1e3)+(M.browser.isTouch?10:2),t=function(a){a.stopPropagation(),a.preventDefault(),p=a.pageX||a.originalEvent.touches[0].pageX,q=c[i],m.css("display","block"),M.redraw(),m.addClass("on"),M.$body.on("touchmove mousemove",u),M.$body.on("touchend touchcancel mouseup",v)},u=function(a){a.stopPropagation(),a.preventDefault(),r=(a.pageX||a.originalEvent.touches[0].pageX)-p;var d=c[i];c[i]=Math.round(Math.max(l[0],Math.min(l[1],q+r/s))/l[2])*l[2],o.css("width",116*(c[i]-l[0])/(l[1]-l[0])+"px"),d!==c[i]&&(b.evalVariables(),g&&g(b.varValues))},v=function(){m.removeClass("on"),setTimeout(function(){m.css("display","none")},200),M.$body.off("touchmove mousemove",u),M.$body.off("touchend touchcancel mouseup",v)};a.on("touchstart mousedown",t)}else if("bolean"===k)c[i]=!!Number(j),a.click(function(){c[i]=!!c[i],b.evalVariables(),g&&g(b.varValues)});else if("switch"===k){c[i]=j;var w=0,x=l.length-1;a.click(function(){x>w?++w:w=0,c[i]=l[w],b.evalVariables(),g&&g(b.varValues)})}return g||null}},M.svg={},M.svg.el=function(a,b,c){var d=this,e="http://www.w3.org/2000/svg";this.$el=document.createElementNS(e,a),this.data={},M.each(b,function(a,b){d.$el.setAttribute(b,a)}),c&&c.append(this)},M.inherit(M.svg.el,M.$),M.svg.el.prototype.setPoints=function(a){this.attr("d",a.length?"M"+a.each(function(a){return a.join(",")}).join("L"):""),this.points=a},M.svg.el.prototype.addPoint=function(a){this.attr("d",this.attr("d")+" L "+a.join(",")),this.points.push(a)},M.svg.el.prototype.getPoints=function(){var a=this.$el.attr("d").replace("M","").split("L");return a.each(function(a){return a.split(",").toNumbers()})},M.piechart=function(a,b,c){var d;if(a>=1)d=['<svg width="',2*b,'" height="',2*b,'">','<path fill="',c,'" stroke="none" d="M',b,",0C",.5*b,",0,0,",.5*b,",0,",b,"s",.5*b,",",b,",",b,",",b,"s",b,"-",.5*b,",",b,"-",b,"S",1.5*b,",0,",b,",0","z M",44.6*b/50,",",76.1*b/50,"L",19.2*b/50,",",48.8*b/50,"l",4*b/50,"-",4.2*b/50,"l",19.8*b/50,",",11.9*b/50,"l",34.2*b/50,"-",32.6*b/50,"l",3.5*b/50,",",3.5*b/50,"L",44.6*b/50,",",76.1*b/50,'z"/>',"</svg>"].join("");else{var e=b+b*Math.sin(2*a*Math.PI),f=b-b*Math.cos(2*a*Math.PI);d=['<svg width="',2*b,'" height="',2*b,'">','<circle cx="',b,'" cy="',b,'" r="',b-.5,'" stroke="',c,'" stroke-width="1" fill="transparent"/>','<path d="M ',b," ",b," L ",b," 0 A ",b," ",b," 0 "+(a>.5?"1":"0")+" 1 "+e+" "+f+' Z" fill="',c,'"/>',"</svg>"].join("")}return d},M.draw=function(a,b){var c=this;a.addClass("m-draw-pointer"),c.options=b,c.drawing=!1,c.paths=[],c.p=null;var d=null;c.start=function(e){c.p&&M.geo.distance(c.p,e)<20?d.addPoint(e):(b.onStart&&b.onStart(e),d=new M.svg.el("path",{"class":"m-draw-path",d:"M "+e.join(",")},b.paths||a),d.points=[e],c.paths.push(d)),c.drawing=!0,c.p=e},c.addPoint=function(a){M.geo.manhatten(c.p,a)>4&&(d.addPoint(a),c.p=a,b.onIntersect&&c.checkForIntersects())},b.noStart||a.on("mousedown touchstart",function(b){b.preventDefault(),b.stopPropagation();var d=M.events.pointerOffset(event,a);c.start(d)}),a.on("mousemove touchmove",function(b){if(c.drawing){b.preventDefault(),b.stopPropagation();var d=M.events.pointerOffset(event,a);c.addPoint(d)}}),a.on("mouseup touchend mouseleave touchleave",function(){c.drawing=!1})},M.draw.prototype.checkForIntersects=function(){if(!(this.paths.length<=1))for(var a=this.paths.last(),b=a.points[a.points.length-2],c=a.points[a.points.length-1],d=0;d<this.paths.length-1;++d)for(var e=this.paths[d].points.length,f=1;e-2>f;++f){var g=M.geo.intersect(b,c,this.paths[d].points[f],this.paths[d].points[f+1]);if(g)return void this.options.onIntersect(g,a,this.paths[d])}},M.draw.prototype.stop=function(){this.drawing=!1,this.p=null},M.draw.prototype.clear=function(){this.paths.each(function(a){a.remove()}),this.paths=[]}}();